name: Deploy

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lowercase repository name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            set -e
            APP_DIR=~/rin-secretary
            mkdir -p $APP_DIR
            cd $APP_DIR

            # 1. Clone or Update Repository
            if [ ! -d .git ]; then
              # カレントディレクトリの中身を全て削除（隠しファイル含む）してクリーンにする
              find . -mindepth 1 -delete
              git clone https://github.com/rintify/RinSecretary.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # 2. Prepare Environment Variables
            RAW_URL="${{ secrets.NEXTAUTH_URL }}"
            DOMAIN=$(echo "$RAW_URL" | sed -E 's/^\s*.*:\/\///g')
            REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            IMAGE_NAME="ghcr.io/$REPO_NAME:latest"

            # 3. Create .env file
            cat > .env <<EOF
            IMAGE_NAME=$IMAGE_NAME
            DOMAIN=$DOMAIN
            NEXTAUTH_URL=https://$DOMAIN
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            AUTH_TRUST_HOST=true
            AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            AUTH_URL=https://$DOMAIN
            ADMIN_DISCORD_WEBHOOK=${{ secrets.ADMIN_DISCORD_WEBHOOK }}
            EOF

            # 4. Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 5. Deploy using the committed configuration files
            # Ensure data directories exist and have correct permissions
            # Fix permissions using a temporary container (avoids host permission issues)
            docker run --rm -v "$(pwd)/data:/data" alpine sh -c "mkdir -p /data/uploads && chown -R 1001:1001 /data && chmod -R 777 /data"

            # 6. Backup Database Before Deploy (if container exists)
            if docker compose -f deploy/docker-compose.yml ps --quiet 2>/dev/null | grep -q .; then
              echo "Backing up database before deploy..."
              docker compose -f deploy/docker-compose.yml exec -T app npx tsx scripts/backup-db.ts || echo "Backup failed or skipped (may be first deploy)"
            else
              echo "No existing container found, skipping backup (first deploy)"
            fi

            # 7. Pull latest image and restart
            docker compose -f deploy/docker-compose.yml --env-file .env pull
            docker compose -f deploy/docker-compose.yml --env-file .env up -d --remove-orphans
            docker image prune -f

            # 8. Notify admin on deploy completion
            curl -H "Content-Type: application/json" \
              -d "{\"content\": \"✅ **デプロイ完了** - $(date '+%Y/%m/%d %H:%M:%S JST')\\n\`${{ github.sha }}\`\"}" \
              "${{ secrets.ADMIN_DISCORD_WEBHOOK }}" || echo "Admin notification failed"
