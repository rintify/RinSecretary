name: Deploy

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            set -e
            mkdir -p ~/rin-secretary
            cd ~/rin-secretary

            # Create data directories
            mkdir -p data/uploads

            # Normalize Domain and Image Name
            RAW_URL="${{ secrets.NEXTAUTH_URL }}"
            DOMAIN=$(echo "$RAW_URL" | sed -E 's/^\s*.*:\/\///g')
            
            # Convert repository name to lowercase for Docker image
            REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            IMAGE_NAME="ghcr.io/$REPO_NAME:latest"

            echo "Deploying $IMAGE_NAME to domain: $DOMAIN"

            # Log in to GHCR on VPS
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Create Caddyfile
            cat > Caddyfile <<EOF
            $DOMAIN, www.$DOMAIN {
              encode gzip
              reverse_proxy web:3000
            }
            EOF

            # Create docker-compose.yml
            cat > docker-compose.yml <<EOF
            services:
              web:
                image: $IMAGE_NAME
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - HOSTNAME=0.0.0.0
                  - DATABASE_URL=file:/data/sqlite.db
                  - NEXTAUTH_URL=https://$DOMAIN
                  - NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
                  - UPLOADS_DIR=/data/uploads
                  - GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
                  - GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
                volumes:
                  - ./data:/data
                  - ./data/uploads:/data/uploads
                command: >
                  sh -c "
                    if [ ! -d ./prisma/migrations ] || [ -z \"\$(ls -A ./prisma/migrations)\" ]; then
                      echo 'First run or no migrations detected, running migrate dev...';
                      npx prisma migrate dev --name init;
                    fi &&
                    npx prisma migrate deploy &&
                    echo 'Starting Scheduler...' &&
                    node scripts/scheduler.js &
                    echo 'Starting Next.js Server...' &&
                    node server.js
                  "
                networks: [webnet]

              caddy:
                image: caddy:2
                restart: unless-stopped
                ports: ["80:80","443:443"]
                volumes:
                  - ./Caddyfile:/etc/caddy/Caddyfile:ro
                  - caddy-data:/data
                  - caddy-config:/config
                depends_on: [web]
                networks: [webnet]

            networks:
              webnet:

            volumes:
              caddy-data:
              caddy-config:
            EOF

            # Deploy
            docker compose pull web
            docker compose up -d --remove-orphans
            docker image prune -f
