name: Deploy

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Timezone & E2E Tests
        run: npm run test:time

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lowercase repository name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            set -e
            
            # --- Configuration (Dynamic) ---
            # Repository full name (e.g. rintify/RinSecretary)
            FULL_REPO="${{ github.repository }}"
            # Repository name only (e.g. RinSecretary) -> rinsecretary (lowercase)
            REPO_SLUG=$(echo "$FULL_REPO" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')
            
            APP_DIR=~/$REPO_SLUG
            REPO_URL="https://github.com/$FULL_REPO.git"
            
            echo "Deploying $FULL_REPO to $APP_DIR..."
            
            mkdir -p $APP_DIR
            cd $APP_DIR

            # 1. Clone or Update Repository
            if [ ! -d .git ]; then
              echo "Initializing new repository..."
              find . -mindepth 1 -delete
              git clone $REPO_URL .
            else
              echo "Updating existing repository..."
              git fetch origin main
              git reset --hard origin/main
            fi

            # 2. Prepare Environment Variables
            RAW_URL="${{ secrets.NEXTAUTH_URL }}"
            # Extract domain clearly: remove protocol, then remove path and trailing slashes
            AUTH_DOMAIN=$(echo "$RAW_URL" | sed -E 's/^\s*.*:\/\///g' | sed -E 's/\/.*//g')
            
            # Use DEPLOY_HOST if provided, otherwise use validity-checked AUTH_DOMAIN
            # This allows deploying to a subdomain while NEXTAUTH_URL might check a different internal path
            HOST_OVERRIDE="${{ secrets.DEPLOY_HOST }}"
            if [ -n "$HOST_OVERRIDE" ]; then
              DOMAIN="$HOST_OVERRIDE"
            else
              DOMAIN="$AUTH_DOMAIN"
            fi
            
            echo "Determined Deployment Domain: $DOMAIN"

            # Variable for docker-compose (ghcr.io/owner/repo:latest)
            LOWER_REPO=$(echo "$FULL_REPO" | tr '[:upper:]' '[:lower:]')
            IMAGE_NAME="ghcr.io/$LOWER_REPO:latest"
            # routable name for traefik (replace / with -)
            ROUTER_NAME=$(echo "$LOWER_REPO" | sed 's/\//-/g')

            # 3. Create .env file
            cat > .env <<EOF
            # --- Common Deployment Vars ---
            IMAGE_NAME=$IMAGE_NAME
            DOMAIN=$DOMAIN
            ROUTER_NAME=$ROUTER_NAME
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
            
            # --- Project Specific Vars (Edit these for new projects) ---
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            AUTH_TRUST_HOST=true
            AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            AUTH_URL=https://$DOMAIN
            ADMIN_DISCORD_WEBHOOK=${{ secrets.ADMIN_DISCORD_WEBHOOK }}
            EOF

            # 4. Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 5. Migration / Cleanup (Ensure ports are free)
            # Stops current app and removes old containers (like Caddy) to free port 80/443
            docker compose -f deploy/docker-compose.yml --env-file .env down --remove-orphans || true

            # 6. Ensure Infrastructure (Global Proxy) is Ready
            # Use the portable script to setup network and proxy if needed
            LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }} bash deploy/ensure-proxy.sh

            # 7. Deploy using the committed configuration files
            # Ensure data directories exist and have correct permissions
            # Fix permissions using a temporary container (avoids host permission issues)
            docker run --rm -v "$(pwd)/data:/data" alpine sh -c "mkdir -p /data/uploads && chown -R 1001:1001 /data && chmod -R 777 /data"

            # 8. Backup Database Before Deploy (if database file exists)
            if [ -f "data/sqlite.db" ]; then
              echo "Backing up database before deploy..."
              curl -F "file=@data/sqlite.db;filename=backup_$(date +%Y%m%d_%H%M%S).db" \
                   -F "content=ðŸ“¦ **Database Backup** - $(date '+%Y/%m/%d %H:%M:%S JST')" \
                   "${{ secrets.ADMIN_DISCORD_WEBHOOK }}" || echo "Backup failed"
            else
              echo "No database file found, skipping backup (first deploy)"
            fi

            # 7. Pull latest image and restart
            docker compose -f deploy/docker-compose.yml --env-file .env pull
            docker compose -f deploy/docker-compose.yml --env-file .env up -d --remove-orphans
            docker image prune -f

            # 8. Notify admin on deploy completion
            curl -H "Content-Type: application/json" \
              -d "{\"content\": \"âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†** - $(date '+%Y/%m/%d %H:%M:%S JST')\\n\`${{ github.sha }}\`\"}" \
              "${{ secrets.ADMIN_DISCORD_WEBHOOK }}" || echo "Admin notification failed"
